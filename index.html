<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WPS</title>
    
    <!-- Vue.js with fallback -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js" 
            onerror="console.error('Failed to load Vue.js from unpkg')"
            onload="console.log('Vue.js loaded successfully')"></script>
    
    <!-- Tailwind CSS with fallback -->
    <script src="https://cdn.tailwindcss.com" 
            onerror="console.error('Failed to load Tailwind CSS')"
            onload="console.log('Tailwind CSS loaded successfully')"></script>
    
    <!-- Fallback for Vue.js if unpkg fails -->
    <script>
        if (typeof Vue === 'undefined') {
            console.error('Vue.js not loaded, trying alternative CDN');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js';
            script.onload = () => console.log('Vue.js loaded from jsdelivr');
            script.onerror = () => console.error('Failed to load Vue.js from jsdelivr');
            document.head.appendChild(script);
        }
    </script>
    
    <style>
        :root {
            --neon-teal: rgb(0, 255, 200);
            --light-blue-bg: #e3f2fd;
            --dark-text: #1976d2;
        }
        
        body {
            background-color: var(--light-blue-bg);
            color: var(--dark-text);
        }
        
        .neon-text {
            color: var(--neon-teal);
            text-shadow: 0 0 2px var(--neon-teal);
        }
        
        .neon-border {
            border-color: var(--neon-teal);
            box-shadow: 0 0 3px var(--neon-teal);
        }
        
        .search-dropdown {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--neon-teal);
            color: #333;
        }
        
        .selected-item {
            background-color: rgba(0, 255, 200, 0.2);
        }
        
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        
        .wallpaper-card {
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .wallpaper-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 255, 200, 0.2);
        }
        
        .info-panel {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .info-panel.expanded {
            max-height: 500px;
            opacity: 1;
        }

        .selected-preview {
            scroll-margin-top: 100px;
        }

        .selected-list-item {
            scroll-margin: 20px;
        }

        .side-panel {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .wallpaper-list-item {
            background: white;
            border-radius: 10px;
            margin-bottom: 1rem;
            padding: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .wallpaper-list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .wallpaper-list-item.selected {
            border: 2px solid var(--neon-teal);
            box-shadow: 0 0 10px rgba(0, 255, 200, 0.3);
        }

        .image-container {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .wallpaper-card:hover .image-container img {
            transform: scale(1.05);
        }

        .image-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
        }

        .image-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 0.9rem;
            text-align: center;
            padding: 20px;
        }

        .image-loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Desktop Layout */
        @media (min-width: 769px) {
            .layout-container {
                display: flex;
            }
            
            .side-panel {
                position: fixed;
                width: 33.333333%;
                height: 100vh;
                overflow-y: auto;
            }
            
            .main-panel {
                margin-left: 33.333333%;
                width: 66.666667%;
            }
            
            .mobile-info-panel {
                display: none;
            }
        }
        
        /* Mobile Layout */
        @media (max-width: 768px) {
            .layout-container {
                display: block;
            }
            
            .side-panel {
                display: none;
            }
            
            .main-panel {
                margin-left: 0 !important;
                width: 100% !important;
            }
            
            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .mobile-info-panel {
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                max-height: 0;
                opacity: 0;
                overflow: hidden;
                background-color: rgba(255, 255, 255, 0.95);
                margin-top: 0;
                border-radius: 0.5rem;
                transform: translateY(-10px);
                pointer-events: none;
                color: #333;
            }

            .mobile-info-panel.expanded {
                max-height: 500px;
                opacity: 1;
                margin-top: 1rem;
                transform: translateY(0);
                pointer-events: auto;
                padding: 1rem;
            }

            .mobile-info-content {
                transition: opacity 0.3s ease;
                opacity: 0;
            }

            .mobile-info-panel.expanded .mobile-info-content {
                opacity: 1;
                transition-delay: 0.2s;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen">
        <!-- Search Bar -->
        <div class="fixed top-0 left-0 right-0 bg-opacity-90 bg-white p-4 z-50 shadow-lg">
            <div class="max-w-4xl mx-auto relative">
                <input 
                    type="text" 
                    v-model="searchQuery"
                    @keydown.down="selectNextResult"
                    @keydown.up="selectPreviousResult"
                    @keydown.enter="selectResult"
                    placeholder="Search by title or use @ for tags..."
                    class="w-full p-2 bg-gray-100 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-400 text-gray-800"
                >
                <!-- Search Results Dropdown -->
                <div v-if="showDropdown" class="search-dropdown absolute w-full mt-2 rounded-lg overflow-hidden z-50 shadow-lg">
                    <div 
                        v-for="(result, index) in searchResults" 
                        :key="index"
                        @click="selectWallpaperFromSearch(result)"
                        :class="['p-2 cursor-pointer hover:bg-gray-100 transition-colors duration-200', 
                                {'selected-item': index === selectedResultIndex}]"
                    >
                        <div class="font-bold text-gray-800">{{ getFilenameWithoutExtension(result.filename) }}</div>
                        <div class="text-sm text-gray-600">
                            Tags: {{ result.tags.join(', ') }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="layout-container pt-20">
            <!-- Test Section (temporary) -->
            <div class="fixed top-20 left-4 bg-white p-4 rounded-lg shadow-lg z-40 max-w-xs">
                <h3 class="font-bold text-gray-800 mb-2">Test Section</h3>
                <div class="text-xs text-gray-600 mb-2">
                    <div>Testing basic functionality...</div>
                </div>
                <!-- Test image -->
                <img src="https://picsum.photos/100/100" alt="Test Image" class="w-full h-20 object-cover rounded mb-2" 
                     onload="console.log('Test image loaded successfully')" 
                     onerror="console.error('Test image failed to load')">
                <div class="text-xs text-gray-500">Test image from Picsum</div>
            </div>

            <!-- Debug Info (temporary) -->
            <div class="fixed top-20 right-4 bg-white p-4 rounded-lg shadow-lg z-40 max-w-xs">
                <h3 class="font-bold text-gray-800 mb-2">Debug Info</h3>
                <div class="text-xs text-gray-600">
                    <div>Total Wallpapers: {{ wallpapers.length }}</div>
                    <div>Loaded Images: {{ Object.keys(imageLoads).length }}</div>
                    <div>Failed Images: {{ Object.keys(imageErrors).length }}</div>
                    <div v-if="selectedWallpaper" class="mt-2">
                        <div>Selected: {{ selectedWallpaper.filename }}</div>
                        <div>URL: {{ selectedWallpaper.github_raw_url }}</div>
                    </div>
                </div>
            </div>

            <!-- Side Panel -->
            <div class="side-panel w-1/3 h-screen overflow-y-auto fixed left-0 p-4 smooth-scroll">
                <div v-for="wallpaper in sortedWallpapers" :key="wallpaper.filename" 
                     class="wallpaper-list-item"
                     :class="{'selected': selectedWallpaper?.filename === wallpaper.filename}"
                     :id="'list-' + wallpaper.filename"
                     class="selected-list-item"
                     @click="selectWallpaperFromList(wallpaper)">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-gray-800">{{ getFilenameWithoutExtension(wallpaper.filename) }}</h3>
                            <div class="text-sm text-gray-600 mt-1">
                                Tags: {{ wallpaper.tags.join(', ') }}
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">
                            {{ wallpaper.metadata.file_size_mb }}MB
                        </div>
                    </div>
                    
                    <div :class="['info-panel', {'expanded': expandedPanels[wallpaper.filename]}]">
                        <div class="mt-4 text-sm text-gray-600">
                            <div class="grid grid-cols-2 gap-2">
                                <div>Resolution:</div>
                                <div>{{ wallpaper.metadata.width }}x{{ wallpaper.metadata.height }}</div>
                                <div>File Size:</div>
                                <div>{{ wallpaper.metadata.file_size_mb }}MB</div>
                                <div>File Type:</div>
                                <div>{{ getFileExtension(wallpaper.filename) }}</div>
                            </div>
                            <a :href="wallpaper.github_raw_url" 
                               target="_blank"
                               class="block mt-4 text-center p-2 rounded-lg border border-blue-400 text-blue-600 hover:bg-blue-400 hover:text-white transition-colors duration-200">
                                Download Wallpaper
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Preview Panel -->
            <div class="main-panel min-h-screen p-4">
                <div class="image-grid">
                    <div v-for="wallpaper in wallpapers" 
                         :key="wallpaper.filename"
                         class="wallpaper-card"
                         :class="{'selected-preview': selectedWallpaper?.filename === wallpaper.filename}"
                         :id="'preview-' + wallpaper.filename"
                         @click="selectWallpaperFromPreview(wallpaper)">
                        <div class="image-container">
                            <img :src="wallpaper.github_raw_url" 
                                 :alt="getFilenameWithoutExtension(wallpaper.filename)"
                                 class="w-full h-48 object-cover transition-transform duration-300 hover:scale-105"
                                 loading="lazy"
                                 @error="handleImageError"
                                 @load="handleImageLoad">
                            
                            <!-- Loading State -->
                            <div v-if="!imageLoads[wallpaper.filename] && !imageErrors[wallpaper.filename]" class="image-loading">
                                <div>Loading...</div>
                            </div>
                            
                            <!-- Error State -->
                            <div v-if="imageErrors[wallpaper.filename]" class="image-error">
                                <div>
                                    <div class="text-lg mb-2">⚠️</div>
                                    <div>Image failed to load</div>
                                    <div class="text-xs mt-1">{{ getFilenameWithoutExtension(wallpaper.filename) }}</div>
                                    <div class="text-xs mt-1 text-red-500">{{ wallpaper.github_raw_url }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile Info Panel -->
                        <div :class="['mobile-info-panel', {'expanded': selectedWallpaper?.filename === wallpaper.filename}]">
                            <div class="mobile-info-content">
                                <div class="text-sm text-gray-600">
                                    <h3 class="font-bold text-gray-800 text-lg mb-2">
                                        {{ getFilenameWithoutExtension(wallpaper.filename) }}
                                    </h3>
                                    <div class="mb-2">
                                        Tags: {{ wallpaper.tags.join(', ') }}
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>Resolution:</div>
                                        <div>{{ wallpaper.metadata.width }}x{{ wallpaper.metadata.height }}</div>
                                        <div>File Size:</div>
                                        <div>{{ wallpaper.metadata.file_size_mb }}MB</div>
                                        <div>File Type:</div>
                                        <div>{{ getFileExtension(wallpaper.filename) }}</div>
                                    </div>
                                    <a :href="wallpaper.github_raw_url" 
                                       target="_blank"
                                       class="block mt-4 text-center p-2 rounded-lg border border-blue-400 text-blue-600 hover:bg-blue-400 hover:text-white transition-colors duration-200">
                                        Download Wallpaper
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test if Vue is available
        console.log('Vue available:', typeof Vue !== 'undefined');
        console.log('Vue version:', Vue?.version || 'Not loaded');
        
        // Test if Tailwind is working
        console.log('Tailwind classes test:', document.createElement('div').className = 'bg-blue-500 p-4');
        
        const { createApp, ref, computed, watch, nextTick } = Vue

        // Check if Vue functions are available
        if (!createApp) {
            console.error('Vue createApp not available');
            document.body.innerHTML = '<div style="padding: 20px; color: red;">Error: Vue.js failed to load properly</div>';
        } else {
            console.log('Vue functions available:', { createApp: !!createApp, ref: !!ref, computed: !!computed });
        }

        createApp({
            setup() {
                const wallpapers = ref([])
                const selectedWallpaper = ref(null)
                const searchQuery = ref('')
                const selectedResultIndex = ref(0)
                const expandedPanels = ref({})
                const imageErrors = ref({})
                const imageLoads = ref({})

                // Helper functions
                const getFilenameWithoutExtension = (filename) => {
                    return filename.split('.').slice(0, -1).join('.')
                }

                const getFileExtension = (filename) => {
                    return filename.split('.').pop().toUpperCase()
                }

                const isMobile = () => window.innerWidth <= 768

                const handleImageError = (event) => {
                    const filename = event.target.alt + '.' + getFileExtension(event.target.src.split('/').pop())
                    imageErrors.value[filename] = true
                    console.error('Failed to load image:', event.target.src, 'for filename:', filename)
                    
                    // Log additional debugging info
                    console.log('Image error details:', {
                        src: event.target.src,
                        filename: filename,
                        alt: event.target.alt,
                        naturalWidth: event.target.naturalWidth,
                        naturalHeight: event.target.naturalHeight
                    })
                }

                const handleImageLoad = (event) => {
                    const filename = event.target.alt + '.' + getFileExtension(event.target.src.split('/').pop())
                    imageLoads.value[filename] = true
                    imageErrors.value[filename] = false
                    console.log('Successfully loaded image:', filename, 'from:', event.target.src)
                }

                // Load wallpapers data
                console.log('Starting to load wallpapers database...');
                fetch('wallpapers_database.json')
                    .then(response => {
                        console.log('Database response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Database loaded successfully, entries:', Object.keys(data).length);
                        wallpapers.value = Object.values(data);
                        console.log('Wallpapers array length:', wallpapers.value.length);
                        
                        // Test if local images are in the data
                        const localImages = wallpapers.value.filter(w => w.github_raw_url.includes('imgs/'));
                        console.log('Local images found:', localImages.length);
                        localImages.forEach(img => console.log('Local image:', img.filename, 'URL:', img.github_raw_url));
                    })
                    .catch(error => {
                        console.error('Failed to load wallpapers database:', error);
                        
                        // Fallback: Create a simple database with just the local images
                        console.log('Creating fallback database with local images...');
                        const fallbackData = {
                            "pic61825.jpg": {
                                "filename": "pic61825.jpg",
                                "tags": ["landscape", "nature", "high-resolution"],
                                "metadata": {
                                    "width": 4000,
                                    "height": 3000,
                                    "aspect_ratio": 1.33,
                                    "file_size": 16777216,
                                    "file_size_mb": 16.0
                                },
                                "github_raw_url": "imgs/pic61825.jpg"
                            },
                            "pic61725.jpg": {
                                "filename": "pic61725.jpg",
                                "tags": ["architecture", "urban", "cityscape"],
                                "metadata": {
                                    "width": 3840,
                                    "height": 2160,
                                    "aspect_ratio": 1.78,
                                    "file_size": 10485760,
                                    "file_size_mb": 10.0
                                },
                                "github_raw_url": "imgs/pic61725.jpg"
                            },
                            "pic61825c.jpg": {
                                "filename": "pic61825c.jpg",
                                "tags": ["ocean", "waves", "seascape"],
                                "metadata": {
                                    "width": 3000,
                                    "height": 2000,
                                    "aspect_ratio": 1.5,
                                    "file_size": 5347737,
                                    "file_size_mb": 5.1
                                },
                                "github_raw_url": "imgs/pic61825c.jpg"
                            },
                            "pic61725c.jpg": {
                                "filename": "pic61725c.jpg",
                                "tags": ["forest", "nature", "trees"],
                                "metadata": {
                                    "width": 4000,
                                    "height": 3000,
                                    "aspect_ratio": 1.33,
                                    "file_size": 15728640,
                                    "file_size_mb": 15.0
                                },
                                "github_raw_url": "imgs/pic61725c.jpg"
                            },
                            "pic61825d.jpg": {
                                "filename": "pic61825d.jpg",
                                "tags": ["sunset", "sky", "colors"],
                                "metadata": {
                                    "width": 3500,
                                    "height": 2500,
                                    "aspect_ratio": 1.4,
                                    "file_size": 11534336,
                                    "file_size_mb": 11.0
                                },
                                "github_raw_url": "imgs/pic61825d.jpg"
                            },
                            "pic61825b.jpg": {
                                "filename": "pic61825b.jpg",
                                "tags": ["mountain", "peak", "landscape"],
                                "metadata": {
                                    "width": 3200,
                                    "height": 2400,
                                    "aspect_ratio": 1.33,
                                    "file_size": 8283750,
                                    "file_size_mb": 7.9
                                },
                                "github_raw_url": "imgs/pic61825b.jpg"
                            }
                        };
                        
                        wallpapers.value = Object.values(fallbackData);
                        console.log('Fallback database created with', wallpapers.value.length, 'images');
                        
                        // Show a notice to the user
                        const notice = document.createElement('div');
                        notice.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; color: #856404; z-index: 1000; max-width: 500px; text-align: center;';
                        notice.innerHTML = '<strong>Note:</strong> Using fallback database with local images only. To see all wallpapers, serve this file through a web server (e.g., using Python: <code>python -m http.server</code>).';
                        document.body.appendChild(notice);
                    })

                const sortedWallpapers = computed(() => {
                    if (!selectedWallpaper.value) return wallpapers.value

                    return [
                        selectedWallpaper.value,
                        ...wallpapers.value.filter(w => w.filename !== selectedWallpaper.value.filename)
                    ]
                })

                const searchResults = computed(() => {
                    if (!searchQuery.value) return []

                    const query = searchQuery.value.toLowerCase()
                    if (query.startsWith('@')) {
                        const tagQuery = query.slice(1)
                        return wallpapers.value.filter(w => 
                            w.tags.some(tag => tag.toLowerCase().includes(tagQuery))
                        )
                    }

                    return wallpapers.value.filter(w => 
                        getFilenameWithoutExtension(w.filename).toLowerCase().includes(query) ||
                        w.tags.some(tag => tag.toLowerCase().includes(query))
                    )
                })

                const showDropdown = computed(() => 
                    searchQuery.value.length > 0 && searchResults.value.length > 0
                )

                // When selecting from list
                const selectWallpaperFromList = async (wallpaper) => {
                    selectedWallpaper.value = wallpaper
                    expandedPanels.value = { [wallpaper.filename]: true }
                    
                    await nextTick()
                    const previewElement = document.getElementById('preview-' + wallpaper.filename)
                    if (previewElement) {
                        previewElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
                    }
                }

                // When selecting from preview
                const selectWallpaperFromPreview = async (wallpaper) => {
                    if (selectedWallpaper.value?.filename === wallpaper.filename) {
                        // Add a small delay before closing to allow animation
                        setTimeout(() => {
                            selectedWallpaper.value = null;
                        }, 50);
                        return;
                    }

                    selectedWallpaper.value = wallpaper;
                    expandedPanels.value = { [wallpaper.filename]: true };
                    
                    if (!isMobile()) {
                        await nextTick();
                        const listElement = document.getElementById('list-' + wallpaper.filename);
                        if (listElement) {
                            listElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }

                // When selecting from search
                const selectWallpaperFromSearch = async (wallpaper) => {
                    selectedWallpaper.value = wallpaper
                    expandedPanels.value = { [wallpaper.filename]: true }
                    searchQuery.value = ''
                    
                    await nextTick()
                    const previewElement = document.getElementById('preview-' + wallpaper.filename)
                    if (previewElement) {
                        previewElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
                    }

                    if (!isMobile()) {
                        const listElement = document.getElementById('list-' + wallpaper.filename)
                        if (listElement) {
                            listElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
                        }
                    }
                }

                const selectNextResult = () => {
                    if (selectedResultIndex.value < searchResults.value.length - 1) {
                        selectedResultIndex.value++
                    }
                }

                const selectPreviousResult = () => {
                    if (selectedResultIndex.value > 0) {
                        selectedResultIndex.value--
                    }
                }

                const selectResult = () => {
                    if (searchResults.value.length > 0) {
                        selectWallpaperFromSearch(searchResults.value[selectedResultIndex.value])
                    }
                }

                watch(searchQuery, () => {
                    selectedResultIndex.value = 0
                })

                return {
                    wallpapers,
                    selectedWallpaper,
                    searchQuery,
                    searchResults,
                    showDropdown,
                    selectedResultIndex,
                    expandedPanels,
                    sortedWallpapers,
                    imageErrors,
                    imageLoads,
                    getFilenameWithoutExtension,
                    getFileExtension,
                    handleImageError,
                    handleImageLoad,
                    selectWallpaperFromList,
                    selectWallpaperFromPreview,
                    selectWallpaperFromSearch,
                    selectNextResult,
                    selectPreviousResult,
                    selectResult
                }
            }
        }).mount('#app')
    </script>
</body>
</html>